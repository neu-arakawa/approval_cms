var AttachUpload=function(){function t(t){var e=document.getElementsByTagName("head").item(0),o=document.createElement("link");o.rel="stylesheet",o.href=t,o.type="text/css",e.appendChild(o)}var e=function(){var t;if(document.currentScript)t=document.currentScript.src;else{var e=document.getElementsByTagName("script");t=(t=e[e.length-1]).src}if(t&&t.match(/^(.+?)([^\/]+?)$/))return RegExp.$1}(),o=window.File&&window.FileReader&&window.FileList&&window.Blob,i=function(){var t=window.navigator.userAgent.toLowerCase();return-1!==t.indexOf("edge")?"edge":-1!==t.indexOf("iemobile")?"iemobile":-1!==t.indexOf("trident/7")?"ie":-1!==t.indexOf("msie")&&-1===t.indexOf("opera")?"ie":-1!==t.indexOf("chrome")&&-1===t.indexOf("edge")?"chrome":-1!==t.indexOf("safari")&&-1===t.indexOf("chrome")?"safari":-1!==t.indexOf("opera")?"opera":-1!==t.indexOf("firefox")?"firefox":null}(),n=("edge"==i||"chrome"==i||"safari"==i||"firefox"==i||"ie"==i&&function(){var t=window.navigator.userAgent.toLowerCase(),e=window.navigator.appVersion.toLowerCase();if(-1!==t.indexOf("trident/7"))return 11;if(-1!==t.indexOf("msie")&&-1===t.indexOf("opera")){if(-1!==e.indexOf("msie 6."))return 6;if(-1!==e.indexOf("msie 7."))return 7;if(-1!==e.indexOf("msie 8."))return 8;if(-1!==e.indexOf("msie 9."))return 9;if(-1!==e.indexOf("msie 10."))return 10}return null}()>=10)&&o;t(e+"css/style.css"),t(e+"lib/font-awesome/font-awesome.min.css");var r=function(t,o){function i(){this.vue||(this.vue=new Vue({el:t,template:'        <div class="attach-upload" v-on:dragover.prevent.stop="onDragover" v-on:dragleave="onDragleave" v-on:drop.prevent.stop="onDrop" v-bind:class="{dragover:dragover}" >          <div class="loading" v-show="isLoadingFile"><div class="progress-wrap"><div class="progress" v-bind:style="{width: uploadProgress + \'%\'}"></div></div></div>          <div class="dnd" v-show="isDndSupported && !filePath" v-on:dblclick="selectFile">            <div class="msg">{{attachLabel}}をドラッグ＆ドロップ</div>          </div>          <div class="content" v-show="filePath">            <transition name="attach" mode="out-in">            <component v-bind:is="attachComponent" v-bind:file="filePath" v-on:file-select="selectFile" />            </transition>          </div>          <button v-show="filePath" class="remove" tabindex="-1" v-on:click.prevent="removeFile">{{attachLabel}}をクリア</button>          <button class="uploader" tabindex="-1" v-on:click.prevent="selectFile">アップロード済みの{{attachLabel}}から選択</button>          <input v-bind:name="inputName" type="hidden" v-bind:value="filePath" />        </div>',data:function(){return{inputName:g,filePath:null,isDndSupported:!n.options.uploaderDomain,dragover:!1,isLoadingFile:!1,uploadProgress:0,attachComponent:null,attachLabel:n.options.onlyImage?"画像":"ファイル"}},components:{fileCmp:v,imageCmp:f},created:function(){this.setFile(m)},mounted:function(){this.$nextTick(function(){n.options.onLoad.call(n)})},methods:{onDragover:function(t){if(!this.isDndSupported)return!1;t.dataTransfer.dropEffect="copy",this.dragover=!0},onDragleave:function(t){if(!this.isDndSupported)return!1;this.dragover=!1},onDrop:function(t){if(!this.isDndSupported)return!1;var e=this;this.dragover=!1,this.isLoadingFile=!0,this.uploadProgress=0;var o=t.dataTransfer.files;file_count=o.length;var i="";0==file_count?i="ファイルが指定されていません":file_count>1&&(i="アップロードできるファイルは1個までです");var s=o[0];if(!i&&s.size>function(t){var e=["B","KB","MB","GB","TB","PB"],t=t.toUpperCase(),o=e.join("|"),i=new RegExp("^(([1-9]\\d*|0)(\\.\\d+)?)\\s*("+o+"?)$");if(t.match(i)){var t=RegExp.$1,n=RegExp.$4,r=e.indexOf(n);return t=Math.floor(t*Math.pow(1024,r))}return null}(n.options.maxFileSize)&&(i="ファイルのサイズが上限("+n.options.maxFileSize+")を超過しています"),i||this._isAcceptable(s.name)||(i="ファイルの種類は "+n.options.allowTypes.join("・")+" のいずれかである必要があります"),i)return this.isLoadingFile=!1,alert(i),!1;r.upload.call(this,s,n.options.uploaderPath,n.options.uploaderDir,function(t){e.isLoadingFile=!1,e.setFile(t)},function(t){e.isLoadingFile=!1,alert(t)},function(t){e.uploadProgress=100*t})},setFile:function(t){if(t&&!this._isAcceptable(t))return alert("ファイルの種類は "+n.options.allowTypes.join("・")+" のいずれかである必要があります"),!1;this._isImage(t)?this.attachComponent="imageCmp":this.attachComponent="fileCmp",this.filePath=t,this.dragover=!1,this.isLoadingFile=!1},removeFile:function(){this.filePath=null},selectFile:function(t){return r.showUploader(n.options.uploaderDomain,n.options.uploaderPath,n.options.uploaderDir,this.setFile),!1},_isImage:function(t){var e=new RegExp(".("+d.join("|")+")$");return!!t.match(e)},_isAcceptable:function(t){var e=n.options.allowTypes;if(e){var o=new RegExp(".("+e.join("|")+")$");if(!t.match(o))return!1}return!0}}}))}var n=this,s=l(t),u={maxFileSize:"2MB",onlyImage:!1,allowTypes:["pdf","doc","docx","xls","xlsx","ppt","pptx","txt","zip","mp4","txt","jpg","jpeg","jpe","gif","png"],uploaderDomain:null,uploaderPath:"/uploader",uploaderDir:"/",onLoad:function(){}},d=["jpg","jpeg","jpe","gif","png"];this.options=function(t){var e={};for(var o in t)e[o]=t[o];return e}(u);for(var c in o)this.options[c]=o[c];for(var c in u){var p="data-"+function(t){return t.replace(/[A-Z]/g,function(t){return"-"+t.charAt(0).toLowerCase()})}(c),h=s.attr(p);if(h){h=h.replace(/\'/g,'"');try{h=JSON.parse(h)}catch(t){}finally{this.options[c]=h}}}this.options.onlyImage&&(this.options.allowTypes=d),this.options.uploaderPath.match(/\/$/)||(this.options.uploaderPath=this.options.uploaderPath+"/"),this.options.uploaderDir.match(/^(\/*)(.*?)(\/*)$/)&&(this.options.uploaderDir=RegExp.$2),this.options.uploaderDomain&&this.options.uploaderDomain.match(/^(.*?)(\/*)$/)&&(this.options.uploaderDomain=RegExp.$1);var f={template:'  <div class="img" v-on:dblclick="onFileSelect">    <img v-bind:src="file" draggable="false" />  </div>',props:["file"],methods:{onFileSelect:function(){this.$emit("file-select")}}},v={template:'  <div class="file" v-on:dblclick="onFileSelect">    <a v-bind:href="file" target="_blank" draggable="false">{{fileName}}</a>  </div>',props:["file"],computed:{fileName:function(){return this.file&&this.file.match(/([^\/]+?)$/)?RegExp.$1:null}},methods:{onFileSelect:function(){this.$emit("file-select")}}},m=s.value(),g=s.name();if("undefined"==typeof Vue){!function(t,e,o){"string"==typeof t&&(t=[t]);var i=[];if(t.forEach(function(e){-1===a.indexOf(t)&&i.push(e)}),0!==i.length){var n=setTimeout(function(){o&&o()},5e3),r=0;i.forEach(function(o){var s=document.getElementsByTagName("head").item(0),l=document.createElement("script");l.src=o,s.appendChild(l),a.push(o),l.onload=function(){++r===i.length&&(clearTimeout(n),e&&e(t));var u=a.indexOf(o);-1!==u&&a.splice(u,1),l.onload=null,s&&l.parentNode&&s.removeChild(l)}})}else e&&e()}([e+"lib/vue/vue.min.js"],function(){i.call(n)},function(){alert("[AttachUpload] ライブラリの読み込みに失敗しました")})}else i.call(n)},s=null;r.showUploader=function(t,e,o,i){if(s)return!1;var n=e;(t=t||"")&&(n=t+n),o&&(n+="#"+o),(s=l('<div class="attach-upload-overlay"><div class="uploader"><button class="close"><i class="fa fa-times" aria-hidden="true"></i></button><iframe src="'+n+'"></iframe></div></div>')).addClass("active").bind("click",r.hideUploader),l("body").append(s),window.selectUploadFile||(window.selectUploadFile=function(e){i&&i(t+e),r.hideUploader()}),window.onmessage||(window.onmessage=function(e){try{var o=JSON.parse(e.data);void 0!==o.path&&i&&i(t+o.path)}catch(e){}r.hideUploader()})},r.hideUploader=function(){if(!s)return!1;s.removeClass("active"),window.selectUploadFile=null,window.onmessage=null,setTimeout(function(){s.remove(),s=null},500)},r.upload=function(t,e,o,i,n,r){var s=new FormData;s.append("dir",o),s.append("action","upload"),s.append("upload",t);var a=new XMLHttpRequest;a.open("POST",e),a.setRequestHeader("X-REQUESTED-WITH","XMLHttpRequest"),a.onreadystatechange=function(t){if(a.readyState===XMLHttpRequest.DONE&&200===a.status)try{var e=JSON.parse(a.response);if(e.errors)return n&&n(e.errors),!1;i&&i(e.result.files[0].web_path)}catch(t){n&&n("不正なデータを受信しました")}},r&&(a.upload.onprogress=function(t){r(t.loaded/t.total)}),a.send(s)};var a=[],l=function(t){if(t instanceof l)return t;if(!(this instanceof l))return new l(t);if(l.isHTMLDocument(t)||l.isHTMLElement(t))this.root=t;else if(l.isHTML(t)){var e=document.createElement("div");e.innerHTML=t,this.root=e.children[0]}else this.root=document.querySelector(t);return this.root?this.tagName=this.root.tagName:this.tagName=null,this};return l.prototype.hasClass=function(t){return!!this.root&&this.root.classList.contains(t)},l.prototype.addClass=function(t){return this.root?this.hasClass(t)?this:(this.root.classList.add(t),this):null},l.prototype.removeClass=function(t){return this.root?(this.root.classList.remove(t),this):null},l.prototype.append=function(t){if(!this.root)return null;var e;return e=t instanceof l?t.HTMLElement():l.HTML2Element(t),this.root.appendChild(e),this},l.prototype.remove=function(){return this.root?(this.root&&this.root.parentNode.removeChild(this.root),null):null},l.prototype.html=function(t){return this.root?void 0===t?this.root.innerHTML:(this.root.innerHTML=t,this):null},l.prototype.text=function(t){return this.root?void 0===t?this.root.textContent:(this.root.textContent=t,this):null},l.prototype.value=function(t){return this.root?void 0===t?this.root.value:(this.root.value=t,this):null},l.prototype.name=function(t){return this.root?void 0===t?this.root.name:this:null},l.prototype.findFirst=function(t){if(!this.root)return null;var e=this.root.querySelector(t);return e?new l(e):null},l.prototype.findAll=function(t){if(!this.root)return null;for(var e=this.root.querySelectorAll(t),o=[],i=0;i<e.length;i++){var n=e[i];o.push(l(n))}return o},l.prototype.closest=function(t){if(!this.root)return null;var e;["matches","webkitMatchesSelector","mozMatchesSelector","msMatchesSelector","oMatchesSelector"].some(function(t){return"function"==typeof document.body[t]&&(e=t,!0)});for(var o=this.root;;){var i=o.parentNode;if(!i||void 0===i[e])break;if(i[e](t))return l(i);o=i}return null},l.prototype.attr=function(t,e){return this.root?void 0===e?this.root.getAttribute(t):(this.root.setAttribute(t,e),this):null},l.prototype.children=function(){if(!this.root)return null;for(var t=this.root.children,e=[],o=0;o<t.length;o++){var i=t[o];e.push(l(i))}return e},l.prototype.bind=function(t,e){return this.root?(this.root.addEventListener(t,e),this):null},l.prototype.unbind=function(t,e){return this.root?(this.root.removeEventListener(t,e),this):null},l.prototype.trigger=function(t){if(!this.root)return null;if(document.createEvent){return(e=document.createEvent("HTMLEvents")).initEvent(t,!0,!0),this.root.dispatchEvent(e)}var e=document.createEventObject();return this.trigger.fireEvent(t,e)},l.prototype.HTMLElement=function(){return this.root?this.root:null},l.prototype.show=function(){return this.root?(this.root.style.display="block",this):null},l.prototype.hide=function(){return this.root?(this.root.style.display="none",this):null},l.exists=function(t,e){void 0===e&&(e="body");return!!l.findFirst(t,e)},l.HTML2Element=function(t){if(l.isHTMLElement(t))return t;var e=document.createElement("div");return e.innerHTML=t,e.children[0]},l.isHTMLElement=function(t){return t instanceof HTMLElement},l.isHTMLDocument=function(t){return"undefined"!=typeof HTMLDocument?t instanceof HTMLDocument:"undefined"!=typeof Document?t instanceof Document:void 0},l.isHTML=function(t){return t.match(/<.+?>/)},function(t,e){if(!n)return alert("[AttachUpload] お使いのブラウザはサポートされていません"),null;if(this.instances=[],console.log(t),t instanceof HTMLElement){a=new r(t,e);this.instances.push(a)}else for(var o=l("body").findAll(t,e),i=o.length,s=0;s<i;s++){var a=new r(o[s].root,e);this.instances.push(a)}}}();